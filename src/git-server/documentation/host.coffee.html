<!DOCTYPE html>
<html>
<head>
  <title>host.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="doc-style.css" />
  <script src="doc-filelist.js"></script>
  <script>
    var relativeDir = "", thisFile = "host.coffee", defaultSidebar = true;
  </script>
  <script src="doc-script.js"></script>
</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">
    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container"><div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
      <tr>
        <td class="docs">
          <h1>host.coffee</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>GOAL: A simple to setup and run, multi-tenant Git Server written in NodeJS.</p>
  </div>
  <div class="body"><p>This was initially created to be used as a multi-tenant git server with powerful event triggers.</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2">&#182;</a>
</div>
<p>Require the modules needed:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nv">pushover  = </span><span class="nx">require</span> <span class="s">&#39;pushover&#39;</span>
<span class="nv">http    = </span><span class="nx">require</span> <span class="s">&#39;http&#39;</span>
<span class="nv">https   = </span><span class="nx">require</span> <span class="s">&#39;https&#39;</span>
<span class="nv">async   = </span><span class="nx">require</span> <span class="s">&#39;async&#39;</span>
<span class="nv">fs      = </span><span class="nx">require</span> <span class="s">&#39;fs&#39;</span>




<span class="k">class</span> <span class="nx">GitServer</span>
  
  
  
  

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Constructor function for each instance of GitServer</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">repos</span>
      <span class="dox_type">Array</span>
      <span>List of repositories</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">repoLocation</span>
      <span class="dox_type">String</span>
      <span>Location where the repo's are/will be stored</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">port</span>
      <span class="dox_type">Int</span>
      <span>Port on which to run this server.</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">certs</span>
      <span class="dox_type">Object</span>
      <span>Object of 'key' and 'cert' with the location of the certs (only used for HTTPS)</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nv">constructor: </span><span class="nf">( @repos = [], @logging = false, @repoLocation = &#39;/tmp/repos&#39;, @port = 7000, @certs )-&gt;</span>
    

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4">&#182;</a>
</div>
<p>Create the pushover git object:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="vi">@git    = </span><span class="nx">pushover</span> <span class="nx">@repoLocation</span><span class="p">,</span> <span class="nx">autoCreate</span><span class="o">:</span><span class="kc">false</span>
    <span class="vi">@permMap  = </span><span class="nx">fetch</span><span class="o">:</span><span class="s">&#39;R&#39;</span><span class="p">,</span> <span class="nx">push</span><span class="o">:</span><span class="s">&#39;W&#39;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5">&#182;</a>
</div>
<p>Setup the repo listeners:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">@gitListeners</span><span class="p">()</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6">&#182;</a>
</div>
<p>Go through all the @repo's and create them if they dont exist:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">@makeReposIfNull</span> <span class="o">=&gt;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7">&#182;</a>
</div>
<p>Route requests to pushover:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">if</span> <span class="nx">@certs</span><span class="o">?</span>
        <span class="vi">@server = </span><span class="nx">https</span><span class="p">.</span><span class="nx">createServer</span> <span class="nx">@certs</span><span class="p">,</span> <span class="nx">@git</span><span class="p">.</span><span class="nx">handle</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">@git</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="nv">red   = </span><span class="o">`</span><span class="s">&#39;\033[31m&#39;</span><span class="o">`</span>
        <span class="nv">reset = </span><span class="o">`</span><span class="s">&#39;\033[0m&#39;</span><span class="o">`</span>
        <span class="nv">message = </span><span class="s">&quot;&quot;&quot;</span>
<span class="s">          WARNING: No SSL certs passed in. Running as HTTP and not HTTPS.</span>
<span class="s">          Be careful, without HTTPS your user/pass will not be encrypted&quot;&quot;&quot;</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">red</span> <span class="o">+</span> <span class="nx">message</span> <span class="o">+</span> <span class="nx">reset</span>
        <span class="vi">@server = </span><span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span> <span class="nx">@git</span><span class="p">.</span><span class="nx">handle</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">@git</span><span class="p">)</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8">&#182;</a>
</div>
<p>Open up the desired port ( 80 requires sudo )</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">@server</span><span class="p">.</span><span class="nx">listen</span> <span class="nx">@port</span><span class="p">,</span> <span class="o">=&gt;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9">&#182;</a>
</div>
<p>Just let the console know we have started.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">@log</span> <span class="s">&#39;Server listening on &#39;</span><span class="p">,</span> <span class="nx">@port</span><span class="p">,</span> <span class="s">&#39;\r&#39;</span>
  
  

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Create a repo on the fly</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">repoName</span>
      <span class="dox_type">Object</span>
      <span>Name of the repo we are creating.</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nv">createRepo: </span><span class="nf">( repo, callback )=&gt;</span>
    <span class="k">if</span> <span class="o">!</span><span class="nx">repo</span><span class="p">.</span><span class="nx">name</span><span class="o">?</span> <span class="o">or</span> <span class="o">!</span><span class="nx">repo</span><span class="p">.</span><span class="nx">anonRead</span><span class="o">?</span>
      <span class="nx">@log</span> <span class="s">&#39;Not enough details, need atleast .name and .anonRead&#39;</span>
      <span class="kc">false</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11">&#182;</a>
</div>
<p>make sure it doesnt already exist:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="o">!</span><span class="nx">@getRepo</span> <span class="nx">repo</span><span class="p">.</span><span class="nx">name</span>
      <span class="nx">@log</span> <span class="s">&#39;Creating repo&#39;</span><span class="p">,</span> <span class="nx">repo</span><span class="p">.</span><span class="nx">name</span>
      <span class="nx">@repos</span><span class="p">.</span><span class="nx">push</span> <span class="nx">repo</span>
      <span class="nx">@git</span><span class="p">.</span><span class="nx">create</span> <span class="nx">repo</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">callback</span>
    <span class="k">else</span>
      <span class="nx">@log</span> <span class="s">&#39;This repo already exists&#39;</span>
  
  
  

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12">&#182;</a>
</div>
<p>Log all arguments passed into this function IF @logging = true</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nv">log: </span><span class="p">()</span><span class="o">=&gt;</span>
    <span class="nv">args = </span><span class="k">for</span> <span class="nx">key</span><span class="p">,</span><span class="nx">value</span> <span class="k">of</span> <span class="nx">arguments</span>
      <span class="s">&quot;</span><span class="si">#{</span><span class="nx">value</span><span class="si">}</span><span class="s">&quot;</span>
    <span class="k">if</span> <span class="nx">@logging</span> <span class="k">then</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;LOG: &quot;</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">)</span>
  
  
  
  

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Process the request and check for basic authentication.</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">gitObject</span>
      <span class="dox_type">Object</span>
      <span>Git object from the pushover module</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">method</span>
      <span class="dox_type">String</span>
      <span>Method we are getting security for ['fetch','push']</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">repo</span>
      <span class="dox_type">Object</span>
      <span>Repo object that we are doing this method on</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nv">processSecurity: </span><span class="nf">( gitObject, method, repo )=&gt;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14">&#182;</a>
</div>
<p>Try to get the auth header</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nv">req   = </span><span class="nx">gitObject</span><span class="p">.</span><span class="nx">request</span>
    <span class="nv">res   = </span><span class="nx">gitObject</span><span class="p">.</span><span class="nx">response</span>
    <span class="nv">auth  = </span><span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s">&#39;authorization&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="nx">auth</span> <span class="o">is</span> <span class="kc">undefined</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15">&#182;</a>
</div>
<p>if they didnt send a auth header, tell them we need one:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nv">res.statusCode = </span><span class="mi">401</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">setHeader</span> <span class="s">&#39;WWW-Authenticate&#39;</span><span class="p">,</span> <span class="s">&#39;Basic realm=&quot;Secure Area&quot;&#39;</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">end</span> <span class="s">&#39;&lt;html&gt;&lt;body&gt;Need some creds son&lt;/body&gt;&lt;/html&gt;&#39;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16">&#182;</a>
</div>
<p>now they should have responded with the auth headers:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">else</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17">&#182;</a>
</div>
<p>Decode the auth string</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nv">plain_auth  = </span><span class="p">(</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span> <span class="nx">auth</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&#39;base64&#39;</span> <span class="p">)</span> <span class="p">).</span><span class="nx">toString</span><span class="p">()</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18">&#182;</a>
</div>
<p>split the string to get username:password</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nv">creds = </span><span class="nx">plain_auth</span><span class="p">.</span><span class="nx">split</span> <span class="s">&#39;:&#39;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19">&#182;</a>
</div>
<p>Send off this user info and authorize it:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">@permissableMethod</span> <span class="nx">creds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">creds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">method</span><span class="p">,</span> <span class="nx">repo</span><span class="p">,</span> <span class="nx">gitObject</span>
  
  
  
  

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Check to see if:  return
Username and password match  return
This user has permission to do this method on this repo</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">username</span>
      <span class="dox_type">String</span>
      <span>Username of the requesting user</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">password</span>
      <span class="dox_type">String</span>
      <span>Password of the requesting user</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">method</span>
      <span class="dox_type">String</span>
      <span>Method we are checking against ['fetch','push']</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">gitObject</span>
      <span class="dox_type">Object</span>
      <span>Git object from pushover module</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nv">permissableMethod: </span><span class="nf">( username, password, method, repo, gitObject )=&gt;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21">&#182;</a>
</div>
<p>Just let the console know someone is trying to do something that requires a password:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">@log</span> <span class="nx">username</span><span class="p">,</span><span class="s">&#39;is trying to&#39;</span><span class="p">,</span> <span class="nx">method</span><span class="p">,</span><span class="s">&#39;on repo:&#39;</span><span class="p">,</span><span class="nx">repo</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span><span class="s">&#39;...&#39;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22">&#182;</a>
</div>
<p>Find the user object:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nv">user = </span><span class="nx">@getUser</span> <span class="nx">username</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="nx">repo</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23">&#182;</a>
</div>
<p>check if the user exists:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="nx">user</span> <span class="o">is</span> <span class="kc">false</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-24" id="section-24">&#182;</a>
</div>
<p>This user isnt in this repo's .users array:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">@log</span> <span class="nx">username</span><span class="p">,</span><span class="s">&#39;was rejected as this user doesnt exist, or password is wrong&#39;</span>
      <span class="nx">gitObject</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span><span class="s">&#39;Wrong username or password&#39;</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="k">if</span> <span class="nx">@permMap</span><span class="p">[</span> <span class="nx">method</span> <span class="p">]</span> <span class="k">in</span> <span class="nx">user</span><span class="p">.</span><span class="nx">permissions</span>
        <span class="nx">@log</span> <span class="nx">username</span><span class="p">,</span><span class="s">&#39;Successfully did a&#39;</span><span class="p">,</span> <span class="nx">method</span><span class="p">,</span><span class="s">&#39;on&#39;</span><span class="p">,</span><span class="nx">repo</span><span class="p">.</span><span class="nx">name</span>
        <span class="nx">@checkTriggers</span> <span class="nx">method</span><span class="p">,</span> <span class="nx">repo</span>
        <span class="nx">gitObject</span><span class="p">.</span><span class="nx">accept</span><span class="p">()</span>
      <span class="k">else</span>
        <span class="nx">@log</span> <span class="nx">username</span><span class="p">,</span><span class="s">&#39;was rejected, no permission to&#39;</span><span class="p">,</span><span class="nx">method</span><span class="p">,</span><span class="s">&#39;on&#39;</span><span class="p">,</span><span class="nx">repo</span><span class="p">.</span><span class="nx">name</span>
        <span class="nx">gitObject</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span><span class="s">&quot;You dont have these permissions&quot;</span><span class="p">)</span>
  
  
  
  

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-25" id="section-25">&#182;</a>
</div>
<p>Setup the listeners for git events:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nv">gitListeners: </span><span class="p">()</span><span class="o">=&gt;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26">&#182;</a>
</div>
<p>On each git push request</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">@git</span><span class="p">.</span><span class="nx">on</span> <span class="s">&#39;push&#39;</span><span class="p">,</span> <span class="nx">@onPush</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-27" id="section-27">&#182;</a>
</div>
<p>On each git fetch request</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">@git</span><span class="p">.</span><span class="nx">on</span> <span class="s">&#39;fetch&#39;</span><span class="p">,</span> <span class="nx">@onFetch</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-28" id="section-28">&#182;</a>
</div>
<p>On each git info request</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">@git</span><span class="p">.</span><span class="nx">on</span> <span class="s">&#39;info&#39;</span><span class="p">,</span> <span class="nx">@onFetch</span>
  
  
  
  

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-29" id="section-29">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Checks all the passed in repo's to make sure they all have a real .git directory.</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nv">makeReposIfNull: </span><span class="nf">( callback )=&gt;</span>
    <span class="nx">@log</span> <span class="s">&#39;Making repos if they dont exist&#39;</span><span class="p">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-30" id="section-30">&#182;</a>
</div>
<p>Get all the repo names in an Array</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nv">repoNames = </span><span class="p">[]</span>
    <span class="k">for</span> <span class="nx">repo</span> <span class="k">in</span> <span class="nx">@repos</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-31" id="section-31">&#182;</a>
</div>
<p>Make sure this repo has the require fields, if so, add to array:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">if</span> <span class="nx">repo</span><span class="p">.</span><span class="nx">name</span><span class="o">?</span> <span class="o">and</span> <span class="nx">repo</span><span class="p">.</span><span class="nx">anonRead</span><span class="o">?</span> <span class="o">and</span> <span class="nx">repo</span><span class="p">.</span><span class="nx">users</span><span class="o">?</span>
        <span class="nx">repoNames</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">repo</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="s">.git&quot;</span><span class="p">)</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-32" id="section-32">&#182;</a>
</div>
<p>This repo was missing some field we require</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">else</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&#39;Bad Repo&#39;</span><span class="p">,</span> <span class="nx">repo</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="s">&#39;is missing an attribute..&#39;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-33" id="section-33">&#182;</a>
</div>
<p>Call .exists on each repo name</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">async</span><span class="p">.</span><span class="nx">reject</span> <span class="nx">repoNames</span><span class="p">,</span> <span class="nx">@git</span><span class="p">.</span><span class="nx">exists</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">@git</span><span class="p">),</span> <span class="nf">( results )=&gt;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-34" id="section-34">&#182;</a>
</div>
<p>If we have repo's that need to be created:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">if</span> <span class="nx">results</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-35" id="section-35">&#182;</a>
</div>
<p>Create each repo that doesn not exist:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s">&#39;Creating repo directory: &#39;</span><span class="p">,</span> <span class="nx">repo</span> <span class="p">)</span> <span class="k">for</span> <span class="nx">repo</span> <span class="k">in</span> <span class="nx">results</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-36" id="section-36">&#182;</a>
</div>
<p>call .create on each repo:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">async</span><span class="p">.</span><span class="nx">map</span> <span class="nx">results</span><span class="p">,</span> <span class="nx">@git</span><span class="p">.</span><span class="nx">create</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">@git</span><span class="p">),</span> <span class="nx">callback</span>
      <span class="k">else</span> <span class="nx">callback</span><span class="p">()</span> <span class="c1"># Otherwise, open up the server.</span>
  
  
  
  

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-37" id="section-37">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>When the git fetch command is triggered, this is fired.</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">fetch</span>
      <span class="dox_type">Object</span>
      <span>Git object from pushover module.</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nv">onFetch: </span><span class="nf">( fetch )=&gt;</span>
    <span class="nx">@log</span> <span class="s">&#39;Got a FETCH call for&#39;</span><span class="p">,</span> <span class="nx">fetch</span><span class="p">.</span><span class="nx">repo</span>
    <span class="nv">repo = </span><span class="nx">@getRepo</span> <span class="nx">fetch</span><span class="p">.</span><span class="nx">repo</span>
    <span class="k">if</span> <span class="nx">repo</span> <span class="o">isnt</span> <span class="kc">false</span> <span class="c1"># if this repo actually exists:</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-38" id="section-38">&#182;</a>
</div>
<p>This repo allows anyone to fetch it, so accept the request:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">if</span> <span class="nx">repo</span><span class="p">.</span><span class="nx">anonRead</span> <span class="o">is</span> <span class="kc">true</span>
        <span class="nx">@checkTriggers</span> <span class="s">&#39;fetch&#39;</span><span class="p">,</span> <span class="nx">repo</span>
        <span class="nx">fetch</span><span class="p">.</span><span class="nx">accept</span><span class="p">()</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-39" id="section-39">&#182;</a>
</div>
<p>this repo has no anon access, so we need to check the user/pass</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">else</span>
        <span class="nx">@processSecurity</span> <span class="nx">fetch</span><span class="p">,</span> <span class="s">&#39;fetch&#39;</span><span class="p">,</span> <span class="nx">repo</span>
    <span class="k">else</span> <span class="c1"># otherwise we need to reject this</span>
      <span class="nx">@log</span> <span class="s">&#39;Rejected - Repo&#39;</span><span class="p">,</span><span class="nx">fetch</span><span class="p">.</span><span class="nx">repo</span><span class="p">,</span><span class="s">&#39;doesnt exist&#39;</span>
      <span class="nx">fetch</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span><span class="s">&#39;This repo doesnt exist&#39;</span><span class="p">)</span>
  
  
  
  

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-40" id="section-40">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>When the git push command is triggered, this is fired.</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">push</span>
      <span class="dox_type">Object</span>
      <span>Git object from pushover module.</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nv">onPush: </span><span class="nf">( push )=&gt;</span>
    <span class="nx">@log</span> <span class="s">&#39;Got a PUSH call for&#39;</span><span class="p">,</span> <span class="nx">push</span><span class="p">.</span><span class="nx">repo</span>
    <span class="nv">repo = </span><span class="nx">@getRepo</span> <span class="nx">push</span><span class="p">.</span><span class="nx">repo</span>
    <span class="k">if</span> <span class="nx">repo</span> <span class="o">isnt</span> <span class="kc">false</span> <span class="c1"># if this repo actually exists:</span>
      <span class="nx">@processSecurity</span> <span class="nx">push</span><span class="p">,</span> <span class="s">&#39;push&#39;</span><span class="p">,</span> <span class="nx">repo</span>
    <span class="k">else</span>
      <span class="nx">@log</span> <span class="s">&#39;Rejected - Repo&#39;</span><span class="p">,</span><span class="nx">push</span><span class="p">.</span><span class="nx">repo</span><span class="p">,</span><span class="s">&#39;doesnt exist&#39;</span>
      <span class="nx">push</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span><span class="s">&#39;This repo doesnt exist&#39;</span><span class="p">)</span>
  
  
  
  

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-41" id="section-41">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Check if this repo has onSuccessful triggers</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">method</span>
      <span class="dox_type">String</span>
      <span>fetch|push</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">repo</span>
      <span class="dox_type">Object</span>
      <span>Repo object we are checking</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nv">checkTriggers: </span><span class="nf">( method, repo )=&gt;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-42" id="section-42">&#182;</a>
</div>
<p>If .onSuccessful exists:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="nx">repo</span><span class="p">.</span><span class="nx">onSuccessful</span><span class="o">?</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-43" id="section-43">&#182;</a>
</div>
<p>If this method exists in it:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">if</span> <span class="nx">repo</span><span class="p">.</span><span class="nx">onSuccessful</span><span class="p">[</span><span class="nx">method</span><span class="p">]</span><span class="o">?</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-44" id="section-44">&#182;</a>
</div>
<p>log it, and call it</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">@log</span> <span class="s">&#39;On successful triggered: &#39;</span><span class="p">,</span> <span class="nx">method</span><span class="p">,</span> <span class="s">&#39;on&#39;</span><span class="p">,</span><span class="nx">repo</span><span class="p">.</span><span class="nx">name</span>
        <span class="nx">repo</span><span class="p">.</span><span class="nx">onSuccessful</span><span class="p">[</span><span class="nx">method</span><span class="p">]</span><span class="o">?</span><span class="p">(</span> <span class="nx">repo</span><span class="p">,</span> <span class="nx">method</span> <span class="p">)</span>
  
  
  
  

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-45" id="section-45">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Get the user object, check user/pass is correct and it exists in this repo.</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">username</span>
      <span class="dox_type">String</span>
      <span>Username to find</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">password</span>
      <span class="dox_type">String</span>
      <span>Password of the Username</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">repo</span>
      <span class="dox_type">Object</span>
      <span>Repo object this user should be in.</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nv">getUser: </span><span class="nf">( username, password, repo )=&gt;</span>
    <span class="k">for</span> <span class="nx">userObject</span> <span class="k">in</span> <span class="nx">repo</span><span class="p">.</span><span class="nx">users</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-46" id="section-46">&#182;</a>
</div>
<p>If we found this user, return it</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">return</span> <span class="nx">userObject</span> <span class="k">if</span> <span class="nx">userObject</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">username</span> <span class="o">is</span> <span class="nx">username</span> <span class="o">and</span> <span class="nx">userObject</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">password</span> <span class="o">is</span> <span class="nx">password</span>
    <span class="kc">false</span> <span class="c1"># Otherwise, return a false</span>
  
  
  
  

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-47" id="section-47">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Get the repo from the array of repos</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">repoName</span>
      <span class="dox_type">String</span>
      <span>Name of the repo we are trying to find</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nv">getRepo: </span><span class="nf">( repoName )=&gt;</span>
    <span class="k">for</span> <span class="nx">repo</span> <span class="k">in</span> <span class="nx">@repos</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-48" id="section-48">&#182;</a>
</div>
<p>If the repo exists, return it. </p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">return</span> <span class="nx">repo</span> <span class="k">if</span> <span class="nx">repo</span><span class="p">.</span><span class="nx">name</span><span class="o">+</span><span class="s">&#39;.git&#39;</span> <span class="o">is</span> <span class="nx">repoName</span>
    <span class="kc">false</span> <span class="c1"># Otherwise, return a false</span>




</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-49" id="section-49">&#182;</a>
</div>
<p>Export this as a module:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nv">module.exports = </span><span class="nx">GitServer</span>
</pre></div>
        </td>
      </tr>
  </tbody>
</table>
  </div>
</body>
</html>
